<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="description" content="网站描述">
    <meta name="keyword" content="">

    <title>springboot使用jwt实现用户身份认证 | 九天博客</title>
    <link rel="shortcut icon" href="/images/logo.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
        
<link rel="stylesheet" href="/css/highlight/github.css">

        
<link rel="stylesheet" href="/css/post.css">

    
<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <header>
    
    <div class="navbar-container">
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="/images/logo.png" alt="" width="30" height="24" class="d-inline-block align-text-top">
                九天博客
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 35vh;">
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/projects">项目</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/essays">随笔</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/notes">笔记</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/about">关于</a>
                    </li>
                    
                </ul>

                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">搜索</button>
                </form>
            </div>
        </div>
    </nav>
</div>

    
    
</header>

    <main><div class="post">
    <h1>springboot使用jwt实现用户身份认证</h1>

    <div>
        
        <a href="/notes/#SpringBoot">SpringBoot</a>
        

        <span>2022-10-11</span>
    </div>

    <div><span id="more"></span>

<h1 id="JWT介绍"><a href="#JWT介绍" class="headerlink" title="JWT介绍"></a>JWT介绍</h1><p>jwt官网： <a target="_blank" rel="noopener" href="https://jwt.io/introduction">https://jwt.io/introduction</a></p>
<p>JWT(Json Web Token)，用来进行<strong>身份认证(Authorization)</strong> 和**信息交换(Information Exchange)**。</p>
<p>JWT是一个字符串，包括以下3部分内容</p>
<ul>
<li>Header - 头部信息</li>
<li>Payload - 有效载荷</li>
<li>Signature - 签名信息</li>
</ul>
<p>JWT由以上3部分的字符串形式构成，表示为： <code>xxxxx.yyyyy.zzzzz</code></p>
<p><strong>Header</strong></p>
<p>头部信息包括2部分内容：类型(type)和签名信息的加密算法(alg)，例如 HMAC SHA256 或 RSA</p>
<p>示例</p>
<pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>
  <span class="hljs-attr">&quot;alg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HS256&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;typ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JWT&quot;</span>
<span class="hljs-punctuation">&#125;</span></code></pre>

<p>头部信息是JWT的第1部分，使用Base64 URL编码。</p>
<p><strong>Payload</strong></p>
<p>有效载荷中的内容是声明(claims)，有3种声明类型：registered, public, private。</p>
<ul>
<li>registered声明，常用的有 iss (issuer), exp (expiration time), sub (subject), aud (audience)</li>
<li>public声明</li>
<li>private声明，是一些自定义的信息(用户名，密码等)</li>
</ul>
<p>示例</p>
<pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>
  <span class="hljs-attr">&quot;sub&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1234567890&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;John Doe&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;admin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">&#125;</span></code></pre>

<p>有效载荷是JWT的第2部分，使用使用Base64 URL编码。</p>
<p><strong>Signature</strong></p>
<p>签名信息是将编码后的头部信息、有效载荷，以及提供的密钥(secret)进行加密后，得到的字符串。</p>
<p>示例</p>
<pre><code class="hljs plaintext">HMACSHA256(
  base64UrlEncode(header) + &quot;.&quot; +
  base64UrlEncode(payload),
  secret)</code></pre>

<p>最终的JWT字符串表示为</p>
<pre><code class="hljs plaintext">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</code></pre>

<p><strong>JWT的工作原理</strong></p>
<p>JWT的原理很简单：</p>
<ul>
<li>用户登录成功后，服务端生成并返回一个jwt token</li>
<li><em>客户端存储token</em>，当客户端请求受保护的服务器资源时，需要携带token信息(推荐在<code>Authorization</code>请求头携带)</li>
<li>服务端对用户提交的token进行解析与认证，根据认证通过与否，返回相应的响应结果。</li>
</ul>
<p>另外，JWT应该设置有效期。</p>
<!--more-->

<h1 id="spring-boot中使用jwt认证"><a href="#spring-boot中使用jwt认证" class="headerlink" title="spring-boot中使用jwt认证"></a>spring-boot中使用jwt认证</h1><p><strong>添加maven依赖</strong></p>
<blockquote>
<p>JWT是一种规范，实现JWT的库有多种语言，多个库，完整的库列表见 <a target="_blank" rel="noopener" href="https://jwt.io/#debugger">https://jwt.io/#debugger</a></p>
<p>这里使用jjwt，github: <a target="_blank" rel="noopener" href="https://github.com/jwtk/jjwt">https://github.com/jwtk/jjwt</a></p>
</blockquote>
<p>maven</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span> <span class="hljs-comment">&lt;!-- or jjwt-gson if Gson is preferred --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Uncomment this next dependency if you are using JDK 10 or earlier and you also want to use </span>
<span class="hljs-comment">     RSASSA-PSS (PS256, PS384, PS512) algorithms.  JDK 11 or later does not require it for those algorithms:</span>
<span class="hljs-comment">&lt;dependency&gt;</span>
<span class="hljs-comment">    &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;</span>
<span class="hljs-comment">    &lt;artifactId&gt;bcprov-jdk15on&lt;/artifactId&gt;</span>
<span class="hljs-comment">    &lt;version&gt;1.60&lt;/version&gt;</span>
<span class="hljs-comment">    &lt;scope&gt;runtime&lt;/scope&gt;</span>
<span class="hljs-comment">&lt;/dependency&gt;</span>
<span class="hljs-comment">--&gt;</span></code></pre>

<p><strong>创建工具类，用于生成、解析、验证token</strong></p>
<pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtil</span>
&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">JwtUtil</span><span class="hljs-params">()</span>&#123;&#125;

    <span class="hljs-comment">/*生成token,并设置过期时间(单位:ms)*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createToken</span><span class="hljs-params">(String key,Map&lt;String,Object&gt; claims,<span class="hljs-type">long</span> ms)</span>
    &#123;
        <span class="hljs-comment">// 设置id</span>
        claims.put(Claims.ID,UUID.randomUUID().toString());
        <span class="hljs-comment">// 设置主题</span>
        claims.put(Claims.SUBJECT,<span class="hljs-string">&quot;blog&quot;</span>);
        <span class="hljs-comment">// 设置过期时间</span>
        <span class="hljs-keyword">if</span>(ms&gt;<span class="hljs-number">0</span>)
        &#123;
            Date exDate=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + ms);
            claims.put(Claims.EXPIRATION,exDate);
        &#125;

        Key secretKey=Keys.hmacShaKeyFor(Decoders.BASE64.decode(key));

        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> Jwts.builder()
                .setClaims(claims) <span class="hljs-comment">// 有效载荷Payload</span>
                .signWith(secretKey,SignatureAlgorithm.HS256) <span class="hljs-comment">// 签名Signature</span>
                .compact(); <span class="hljs-comment">// 拼接JWT的3部分内容</span>

        <span class="hljs-keyword">return</span> token;
    &#125;

    <span class="hljs-comment">/*解析token*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jws&lt;Claims&gt; <span class="hljs-title function_">parseToken</span><span class="hljs-params">(String key,String token)</span>
    &#123;
        <span class="hljs-keyword">try</span>
        &#123;
            Key secretKey=Keys.hmacShaKeyFor(Decoders.BASE64.decode(key));
            Jws&lt;Claims&gt; jws = Jwts.parserBuilder()
                    .setSigningKey(secretKey) <span class="hljs-comment">// 设置密钥</span>
                    .build()
                    .parseClaimsJws(token);<span class="hljs-comment">// 解析jws</span>
            <span class="hljs-comment">//OK, we can trust this JWT</span>
            <span class="hljs-keyword">return</span> jws;
        &#125;
        <span class="hljs-keyword">catch</span>(JwtException e)
        &#123;
            <span class="hljs-comment">//don&#x27;t trust the JWT!</span>
            log.info(e.getMessage());
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    &#125;

    <span class="hljs-comment">/*验证token*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyToken</span><span class="hljs-params">(String key,String token)</span>
    &#123;
        <span class="hljs-keyword">if</span>(token==<span class="hljs-literal">null</span>)
        &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        &#125;
        <span class="hljs-keyword">return</span> parseToken(key,token)!=<span class="hljs-literal">null</span>;
    &#125;

    <span class="hljs-comment">/*生成密钥*/</span>
    <span class="hljs-comment">/*一般做法是将密钥写到配置文件中，然后获取*/</span> 
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSecretKey</span><span class="hljs-params">()</span>
    &#123;
        <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.secretKeyFor(SignatureAlgorithm.HS256); <span class="hljs-comment">//or HS384 or HS512</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">secretString</span> <span class="hljs-operator">=</span> Encoders.BASE64.encode(key.getEncoded());
        <span class="hljs-keyword">return</span> secretString;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>
    &#123;
        String secretKey=generateSecretKey();
        log.info(secretKey); <span class="hljs-comment">// NeAWmxpPmPbTkHLoPBaKoFGC9LNZcxP8pL/BSOjUonM=</span>

        Map&lt;String,Object&gt; claimsMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        claimsMap.put(<span class="hljs-string">&quot;username&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtUtil.createToken(secretKey,claimsMap,<span class="hljs-number">1000</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">2</span>); <span class="hljs-comment">// 有效期2h</span>
        log.info(token);

        Jws&lt;Claims&gt; jws = JwtUtil.parseToken(secretKey,token);
        log.info(jws.getBody().get(<span class="hljs-string">&quot;username&quot;</span>,String.class));
    &#125;
&#125;</code></pre>

<p><strong>配置密钥</strong></p>
<p>创建密钥（任意字符串，推荐使用jwt提供的相关工具生成，这里使用JWT工具类中定义的 <code>generateSecretKey()</code> 方法生成）</p>
<p>将jwt密钥写到配置文件中</p>
<pre><code class="hljs yml"><span class="hljs-attr">my:</span>
  <span class="hljs-attr">auth:</span>
    <span class="hljs-attr">secret:</span> <span class="hljs-string">NeAWmxpPmPbTkHLoPBaKoFGC9LNZcxP8pL/BSOjUomQ=</span> <span class="hljs-comment"># jwt密钥</span></code></pre>

<p>创建配置属性类，用于获取配置文件中的密钥</p>
<pre><code class="hljs java"><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;my.auth&quot;)</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminProperties</span>
&#123;
    <span class="hljs-keyword">private</span> String secret;
&#125;</code></pre>

<p><strong>登录成功后，发送token给客户端</strong></p>
<pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(&quot;/api/v1&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span>
&#123;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AdminProperties adminProperties;

    <span class="hljs-comment">/*登录*/</span>
    <span class="hljs-meta">@PostMapping(path = &quot;/login&quot;,consumes = MediaType.APPLICATION_JSON_VALUE,produces = MediaType.APPLICATION_JSON_VALUE)</span>
    <span class="hljs-keyword">public</span> JsonResult <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String,String&gt; map)</span>
    &#123;
        String username=map.get(<span class="hljs-string">&quot;username&quot;</span>);
        String password=map.get(<span class="hljs-string">&quot;password&quot;</span>);
        String captcha=map.get(<span class="hljs-string">&quot;captcha&quot;</span>);
        String captchaKey=map.get(<span class="hljs-string">&quot;captchaKey&quot;</span>);

        <span class="hljs-comment">// 校验用户名与密码</span>
        <span class="hljs-comment">// 校验验证码</span>
        <span class="hljs-comment">// 登录成功，创建jwt，返回给用户</span>
        Map&lt;String,Object&gt; claimsMap=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        claimsMap.put(<span class="hljs-string">&quot;username&quot;</span>,username);
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtUtil.createToken(adminProperties.getSecret(),claimsMap,Constant.JWT_EXPIRATION);

        <span class="hljs-type">JsonResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> JsonResult.ok(<span class="hljs-string">&quot;登录成功&quot;</span>);
        result.setData(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AdminDTO</span>(username,token));
        <span class="hljs-keyword">return</span> result;
    &#125;
&#125;</code></pre>

<p><strong>客户端保存token，之后在访问受保护的路由或资源时，在请求头中携带token信息</strong></p>
<p>典型的做法是在请求头的<code>Authorization</code>中携带token信息，使用 Bearer Schema，看起来像下面这样</p>
<pre><code class="hljs plaintext">Authorization: Bearer &lt;token&gt;</code></pre>

<p>客户端使用vue + vue-router + axios 实现</p>
<p>登录成功后，从响应中获取token信息，将其保存到浏览器中(Cookie,LocalStorage等)</p>
<pre><code class="hljs js"><span class="hljs-title function_">doLogin</span>(<span class="hljs-params"></span>)&#123;
    <span class="hljs-keyword">var</span> body=&#123;
        <span class="hljs-attr">username</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span>.<span class="hljs-title function_">trim</span>(),
        <span class="hljs-attr">password</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>.<span class="hljs-title function_">trim</span>(),
        <span class="hljs-attr">captcha</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">captcha</span>.<span class="hljs-title function_">trim</span>(),
        <span class="hljs-attr">captchaKey</span>:<span class="hljs-variable language_">this</span>.<span class="hljs-property">captchakey</span>.<span class="hljs-title function_">trim</span>()
    &#125;

    http.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/admin/login&quot;</span>,body)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span>=&gt;</span>&#123;
            <span class="hljs-keyword">let</span> result=response.<span class="hljs-property">data</span>;
            <span class="hljs-keyword">if</span>(result.<span class="hljs-property">ok</span>)
            &#123;
                <span class="hljs-keyword">let</span> data=result.<span class="hljs-property">data</span>;
                <span class="hljs-keyword">let</span> username=data.<span class="hljs-property">username</span>;
                <span class="hljs-keyword">let</span> token=data.<span class="hljs-property">token</span>;
                <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;username&quot;</span>,username); <span class="hljs-comment">// 保存用户名</span>
                <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&quot;token&quot;</span>,token); <span class="hljs-comment">// 保存token</span>
                <span class="hljs-comment">// 跳转到首页</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>(&#123;<span class="hljs-attr">name</span>:<span class="hljs-string">&quot;dashboard&quot;</span>&#125;);
            &#125;
            <span class="hljs-keyword">else</span>&#123;
                <span class="hljs-title function_">alert</span>(result.<span class="hljs-property">message</span>);
            &#125;
        &#125;)
&#125;</code></pre>

<p>使用axios的拦截器功能，在请求头中添加token信息</p>
<p>http.js</p>
<pre><code class="hljs js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;axios&#x27;</span>;

<span class="hljs-comment">// 创建axios实例</span>
<span class="hljs-keyword">const</span> http = axios.<span class="hljs-title function_">create</span>(&#123;
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&#x27;http://localhost:10000/api/v1&#x27;</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">headers</span>: &#123;
        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,
        <span class="hljs-string">&#x27;Accept&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>
    &#125;
&#125;);

<span class="hljs-comment">// 添加请求拦截器</span>
http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) &#123;
        <span class="hljs-comment">// 在发送请求之前,添加token信息        </span>
        <span class="hljs-comment">// 拦截需要token认证的请求</span>
        <span class="hljs-keyword">let</span> skipUrls=[<span class="hljs-string">&#x27;/captcha&#x27;</span>,<span class="hljs-string">&#x27;/admin/login&#x27;</span>];
        <span class="hljs-keyword">let</span> url = config.<span class="hljs-property">url</span>;
        <span class="hljs-keyword">if</span>(skipUrls.<span class="hljs-title function_">indexOf</span>(url)==-<span class="hljs-number">1</span>)&#123;
            <span class="hljs-keyword">let</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&quot;token&quot;</span>);
            <span class="hljs-keyword">if</span>(token)&#123;
                config.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Authorization&#x27;</span>]=<span class="hljs-string">&#x27;Bearer &#x27;</span>+token;
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> config;
    &#125;,
    <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) &#123;
        <span class="hljs-comment">// 对请求错误做些什么</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    &#125;
);

<span class="hljs-comment">// 添加响应拦截器</span>
http.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) &#123;
        <span class="hljs-comment">// 对响应数据做点什么</span>
        <span class="hljs-keyword">return</span> response;
    &#125;,
    <span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) &#123;
        <span class="hljs-comment">// 对响应错误做点什么</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    &#125;
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> http;</code></pre>

<p><strong>服务端验证token信息的有效性</strong></p>
<p>服务端从请求头中获取token，验证是否有效。</p>
<p>spring-boot中，在每个受保护的控制器方法中验证token，非常繁琐，可以利用拦截器进行统一处理。</p>
<p>定义注解，用于对需要验证token的方法进行标记</p>
<pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> TokenVerify
&#123;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">required</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;
&#125;</code></pre>

<p>定义异常，用于区分认证token异常</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span>
&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AuthException</span><span class="hljs-params">()</span>
    &#123;
        <span class="hljs-built_in">super</span>();
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AuthException</span><span class="hljs-params">(String message)</span>
    &#123;
        <span class="hljs-built_in">super</span>(message);
    &#125;
&#125;</code></pre>

<p>定义拦截器，在Controller方法运行之前验证token</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span>
&#123;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AdminProperties adminProperties;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,HttpServletResponse response,Object handler)</span> <span class="hljs-keyword">throws</span> Exception
    &#123;
        <span class="hljs-comment">// 忽略非处理器方法</span>
        <span class="hljs-keyword">if</span>(!(handler <span class="hljs-keyword">instanceof</span> HandlerMethod))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        &#125;

        HandlerMethod handlerMethod=(HandlerMethod)handler;
        Method method=handlerMethod.getMethod();

        <span class="hljs-comment">// 检查是否使用了认证token注解</span>
        <span class="hljs-keyword">if</span> (method.isAnnotationPresent(TokenVerify.class)) &#123;
            <span class="hljs-type">TokenVerify</span> <span class="hljs-variable">tokenVerify</span> <span class="hljs-operator">=</span> method.getAnnotation(TokenVerify.class);
            <span class="hljs-keyword">if</span> (tokenVerify.required()) &#123;
                <span class="hljs-comment">// 提取token: Authorization: Bearer &lt;token&gt;</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">authorization</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;Authorization&quot;</span>);
                <span class="hljs-type">int</span> index;
                <span class="hljs-keyword">if</span>(TextUtil.isEmpty(authorization) || (index = authorization.indexOf(<span class="hljs-string">&quot;Bearer&quot;</span>))==-<span class="hljs-number">1</span>)
                &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthException</span>(<span class="hljs-string">&quot;认证token不存在&quot;</span>);
                &#125;
                <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authorization.substring(index + <span class="hljs-string">&quot;Bearer&quot;</span>.length()+<span class="hljs-number">1</span>);
                <span class="hljs-comment">// 验证token是否有效</span>
                <span class="hljs-keyword">if</span>(!JwtUtil.verifyToken(adminProperties.getSecret(),token))
                &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthException</span>(<span class="hljs-string">&quot;认证token已失效&quot;</span>);
                &#125;
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request,HttpServletResponse response,Object handler,ModelAndView modelAndView)</span>
            <span class="hljs-keyword">throws</span> Exception
    &#123;
        HandlerInterceptor.<span class="hljs-built_in">super</span>.postHandle(request,response,handler,modelAndView);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request,HttpServletResponse response,Object handler,Exception ex)</span>
            <span class="hljs-keyword">throws</span> Exception
    &#123;
        HandlerInterceptor.<span class="hljs-built_in">super</span>.afterCompletion(request,response,handler,ex);
    &#125;
&#125;</code></pre>

<p>注册拦截器</p>
<pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebMvc</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span>
&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span>
    &#123;
        registry.addInterceptor(tokenInterceptor())
                .addPathPatterns(<span class="hljs-string">&quot;/api/v1/admin/**&quot;</span>)
                .excludePathPatterns(<span class="hljs-string">&quot;/api/v1/admin/login&quot;</span>); <span class="hljs-comment">// 不拦截登录路由</span>
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TokenInterceptor <span class="hljs-title function_">tokenInterceptor</span><span class="hljs-params">()</span>
    &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenInterceptor</span>();
    &#125;
&#125;</code></pre>

<p>统一处理认证异常，返回认证失败消息</p>
<pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyExceptionHandler</span>
&#123;
    <span class="hljs-meta">@ExceptionHandler(value = &#123;AuthException.class&#125;)</span>
    <span class="hljs-keyword">public</span> JsonResult <span class="hljs-title function_">authExceptionHandler</span><span class="hljs-params">(HttpServletRequest request,AuthException e)</span>
    &#123;
        String message=e.getMessage();
        log.info(message);
        <span class="hljs-keyword">return</span> JsonResult.error(<span class="hljs-number">403</span>,message);
    &#125;

    <span class="hljs-comment">// 其它异常</span>
&#125;</code></pre>

<p>在需要进行验证的控制器方法上，使用自定义的注解进行标记即可</p>
<pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminController</span>&#123;
    <span class="hljs-comment">/*获取登录状态*/</span>
    <span class="hljs-meta">@GetMapping(&quot;/status&quot;)</span>
    <span class="hljs-meta">@TokenVerify</span>
    <span class="hljs-keyword">public</span> JsonResult <span class="hljs-title function_">status</span><span class="hljs-params">()</span>
    &#123;
        <span class="hljs-keyword">return</span> JsonResult.ok(<span class="hljs-string">&quot;已登录&quot;</span>);
    &#125;
&#125;</code></pre>



<h1 id="java-jwt"><a href="#java-jwt" class="headerlink" title="java-jwt"></a>java-jwt</h1><blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/auth0/java-jwt">https://github.com/auth0/java-jwt</a></p>
</blockquote>
<p>maven添加依赖</p>
<pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.18.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre>

<p>工具类</p>
<pre><code class="hljs java"><span class="hljs-keyword">package</span> com.lyp.util;

<span class="hljs-keyword">import</span> com.auth0.jwt.JWT;
<span class="hljs-keyword">import</span> com.auth0.jwt.JWTVerifier;
<span class="hljs-keyword">import</span> com.auth0.jwt.algorithms.Algorithm;
<span class="hljs-keyword">import</span> com.auth0.jwt.exceptions.JWTCreationException;
<span class="hljs-keyword">import</span> com.auth0.jwt.exceptions.JWTVerificationException;
<span class="hljs-keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtil</span> &#123;
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">JwtUtil</span><span class="hljs-params">()</span>&#123;&#125;

    <span class="hljs-comment">/*创建Token*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createToken</span><span class="hljs-params">(String secret)</span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-type">Algorithm</span> <span class="hljs-variable">algorithm</span> <span class="hljs-operator">=</span> Algorithm.HMAC256(secret);
            <span class="hljs-keyword">return</span> JWT.create()
                    .withIssuer(<span class="hljs-string">&quot;auth0&quot;</span>)
                    .withExpiresAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis()+<span class="hljs-number">30</span>*<span class="hljs-number">60</span>*<span class="hljs-number">1000</span>)) <span class="hljs-comment">// 30min有效期</span>
                    .sign(algorithm);
        &#125; <span class="hljs-keyword">catch</span> (JWTCreationException exception)&#123;
            <span class="hljs-comment">//Invalid Signing configuration / Couldn&#x27;t convert Claims.</span>
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    &#125;
    
    <span class="hljs-comment">/*解析Token*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DecodedJWT <span class="hljs-title function_">parseToken</span><span class="hljs-params">(String secret,String token)</span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-type">Algorithm</span> <span class="hljs-variable">algorithm</span> <span class="hljs-operator">=</span> Algorithm.HMAC256(secret);
            <span class="hljs-type">JWTVerifier</span> <span class="hljs-variable">verifier</span> <span class="hljs-operator">=</span> JWT.require(algorithm)
                    .withIssuer(<span class="hljs-string">&quot;auth0&quot;</span>)
                    .build(); <span class="hljs-comment">//Reusable verifier instance</span>
            <span class="hljs-type">DecodedJWT</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> verifier.verify(token);
            <span class="hljs-keyword">return</span> jwt;
        &#125; <span class="hljs-keyword">catch</span> (JWTVerificationException exception)&#123;
            <span class="hljs-comment">//Invalid signature/claims</span>
            exception.printStackTrace();
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    &#125;

    <span class="hljs-comment">/*验证Token*/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyToken</span><span class="hljs-params">(String secret,String token)</span>&#123;
        <span class="hljs-keyword">if</span> (token==<span class="hljs-literal">null</span>)
        &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        &#125;
        <span class="hljs-keyword">return</span> parseToken(secret,token)!=<span class="hljs-literal">null</span>;
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> createToken(<span class="hljs-string">&quot;abc123&quot;</span>);
        System.out.println(token);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> verifyToken(<span class="hljs-string">&quot;abc123&quot;</span>, token);
        System.out.println(success);
    &#125;
&#125;
</code></pre>

</div>
</div>

<div class="post-end">END</div></main>

    <footer>
页底
</footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
    
</body>
</html>