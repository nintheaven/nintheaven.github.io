<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="description" content="网站描述">
    <meta name="keyword" content="">

    <title>springboot前后端分类项目中验证码功能的实现 | 九天博客</title>
    <link rel="shortcut icon" href="/images/logo.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/style.css">

    
        
<link rel="stylesheet" href="/css/index.css">

    
<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <header>
    
    <div class="navbar-container">
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="/images/logo.png" alt="" width="30" height="24" class="d-inline-block align-text-top">
                九天博客
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 35vh;">
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/projects">项目</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/essays">随笔</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/notes">笔记</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/about">关于</a>
                    </li>
                    
                </ul>

                <form class="d-flex" role="search">
                    <input class="form-control me-2" type="search" placeholder="" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">搜索</button>
                </form>
            </div>
        </div>
    </nav>
</div>

    
    
</header>

    <main><h1>springboot前后端分类项目中验证码功能的实现</h1>

<span>SpringBoot</span>

<span>2022-10-11</span>
<div><span id="more"></span>

<p>验证码工具开源库：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://hub.fastgit.org/whvcse/EasyCaptcha">https://hub.fastgit.org/whvcse/EasyCaptcha</a></li>
</ul>
<h1 id="传统的Web项目"><a href="#传统的Web项目" class="headerlink" title="传统的Web项目"></a>传统的Web项目</h1><p>传统的Web项目中，经典的验证码实现过程如下：</p>
<p>1.后端定义接口，生成验证码及图片，并将验证码保存到session中，将验证码图片写出到响应中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/captcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCaptcha</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 生成验证码及图片</span></span><br><span class="line">    String captcha=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将验证码码存入session中</span></span><br><span class="line">    request.getSession().setAttribute(<span class="string">&quot;captcha&quot;</span>, captcha);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置响应头(输出图片类型)</span></span><br><span class="line">    response.setContentType(<span class="string">&quot;image/gif&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;No-cache&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">    response.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回验证码图片</span></span><br><span class="line">    response.getOutputStream().write(imageBytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.前端显示验证码，img标签中的src设置为验证码API接口url</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/captcha&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;验证码&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.前端提交信息中包括用户输入的验证码信息</p>
<p>4.后端校验信息，从session中获取验证码，与用户提交的验证码进行比对。</p>
<h1 id="前后端分离项目"><a href="#前后端分离项目" class="headerlink" title="前后端分离项目"></a>前后端分离项目</h1><p>spring-boot前后端分离项目中，因为前端项目与后端项目是2个完全独立的项目，使用session无法完成信息的存储。需要借助于redis。</p>
<p>1.添加redis依赖，并进行必要的配置</p>
<p>2.后端定义接口，生成验证码及图片，将验证码保存到redis中，返回图片保存到redis中的key和图片的base64编码字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/captcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> JsonResult <span class="title function_">getCaptcha</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 生成验证码及图片</span></span><br><span class="line">    String captcha=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码存入redis</span></span><br><span class="line">    String key= UUID.randomUUID().toString();</span><br><span class="line">    redisUtil.setEX(key,captcha,<span class="number">5L</span>,TimeUnit.MINUTES); <span class="comment">// 5分钟有效期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回key和图片的base64码</span></span><br><span class="line">    <span class="type">JsonResult</span> <span class="variable">result</span> <span class="operator">=</span> JsonResult.ok(<span class="string">&quot;验证码创建成功&quot;</span>);</span><br><span class="line">    Map&lt;String,String&gt; data=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    data.put(<span class="string">&quot;key&quot;</span>,key);</span><br><span class="line">    data.put(<span class="string">&quot;image&quot;</span>,gifCaptcha.toBase64());</span><br><span class="line">    result.setData(data);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.前端显示验证码，img标签中的src需要使用ajax动态获取</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;captcha-img&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;验证码&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;getCaptcha&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">getCaptcha</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">&quot;/api/captcha&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span>=&gt;</span>response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(result.<span class="property">ok</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">captchakey</span>=result.<span class="property">data</span>.<span class="property">key</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> captchaImage=result.<span class="property">data</span>.<span class="property">image</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#captcha-img&#x27;</span>).<span class="property">src</span>=captchaImage;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">getCaptcha</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>4.前端提交信息中包括验证码及后端传过来的key</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">doLogin</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> data=&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">username</span>:<span class="variable language_">this</span>.<span class="property">username</span>.<span class="title function_">trim</span>(),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">password</span>:<span class="variable language_">this</span>.<span class="property">password</span>.<span class="title function_">trim</span>(),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">captcha</span>:<span class="variable language_">this</span>.<span class="property">captcha</span>.<span class="title function_">trim</span>(),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">captchaKey</span>:<span class="variable language_">this</span>.<span class="property">captchakey</span>.<span class="title function_">trim</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">&quot;/api/admin/login&quot;</span>,&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data),</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5.后端校验信息，根据用户提交的key从redis中获取验证码，与用户提交的验证码进行比对。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(path = &quot;/login&quot;,consumes = MediaType.APPLICATION_JSON_VALUE,produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> JsonResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String,String&gt; map)</span></span><br><span class="line">&#123;</span><br><span class="line">    String username=map.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">    String password=map.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">    String captcha=map.get(<span class="string">&quot;captcha&quot;</span>);</span><br><span class="line">    String captchaKey=map.get(<span class="string">&quot;captchaKey&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验用户名和密码</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">redisCaptcha</span> <span class="operator">=</span> redisUtil.get(captchaKey);<span class="comment">// 获取redis中的验证码</span></span><br><span class="line">    <span class="keyword">if</span>(redisCaptcha==<span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> JsonResult.error(<span class="string">&quot;验证码失效&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (captcha==<span class="literal">null</span> || !redisCaptcha.equals(captcha.trim().toLowerCase())) &#123;</span><br><span class="line">        <span class="keyword">return</span> JsonResult.error(<span class="string">&quot;验证码输入错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验其它信息</span></span><br><span class="line">    <span class="keyword">return</span> JsonResult.ok(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div>
<div>END</div></main>

    <footer>
页底
</footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
</body>
</html>